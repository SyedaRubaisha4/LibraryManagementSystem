@model Models.DTOModel.BookViewModal



    @if (TempData["BookSuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["BookSuccessMessage"]
        </div>
    }
    
    <div class="row ">
       
        <div class="d-flex col-xl-12  justify-content-between">

            <h2 class="mb-2"> All Books </h2>
            <button type="button" class="btn mb-2 text-light" style="border-radius:15px;background-color:darkblue" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                <i class="bi bi-book text-light me-1"></i>   Add Book
            </button>

            <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add book</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-black">
                            <form method="post" asp-action="@((Model.Book?.Id ?? 0) == 0 ? "Add" : "Update")" asp-controller="Book" enctype="multipart/form-data">
                                <div class="bg-light rounded h-100 p-4">
                                    <h6 class="mb-4">@((Model.Book?.Id ?? 0) == 0 ? "Add Book" : "Edit Book")</h6>

                                    <!-- Hidden field for Id -->
                                    <input type="hidden" name="Id" value="@Model.Book?.Id" />

                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" name="Name" id="floatingInput"
                                               placeholder="Name" value="@Model.Book?.Name" />
                                        <label for="floatingInput">Name</label>
                                    </div>

                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" name="Description" id="floatingDescription"
                                               placeholder="Description" value="@Model.Book?.Description" />
                                        <label for="floatingDescription">Description</label>
                                    </div>

                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" name="Author" id="floatingAuthor"
                                               placeholder="Author" value="@Model.Book?.Author" />
                                        <label for="floatingAuthor">Book Author</label>
                                    </div>

                                    <div class="form-floating mb-3">
                                        <input type="date" class="form-control" name="BookCreationDate" id="floatingDate"
                                               placeholder="Date" value="@(Model?.Book.BookCreationDate)" />
                                        <label for="floatingDate">Book Publishing Date</label>
                                    </div>

                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control" name="Price" id="floatingDate"
                                               placeholder="Date" value="@(Model?.Book.Price)" />
                                        <label for="floatingDate">Book Price</label>
                                    </div>
                                <div class="form-floating">
                                    <select id="fruits" name="SelectedCategories" data-placeholder="Select fruits" multiple data-multi-select>
                                        @foreach (var category in (List<SelectListItem>)ViewData["category"])
                                        {
                                            <option value="@category.Value">@category.Text</option>
                                        }
                                    </select>
                                </div>

                              
                                    <div class="form-floating mb-4">
                                        <input type="file" class="form-control" name="Image" accept="image/*" value="@Model.Book.Image" placeholder="Image">
                                        <label for="floatingInput">Book Image</label>

                                    </div>
                                    <div class="form-floating mb-3">
                                        <input type="file"
                                               class="form-control"
                                               name="PdfFile"
                                               placeholder="Book"
                                               accept="application/pdf"
                                               required />
                                        <label for="PdfFile">Book</label>
                                    </div>

                                    <button type="submit" class="btn btn-primary d-flex justify-content-center">Submit</button>
                                </div>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="col-sm-12 col-xl-12">
         
        <div class="bg-light rounded h-100 ">
          <div class="table-responsive">
             <table class="table table-striped ">
                <thead>
                            <tr >

                                <td style="text-align: right;" colspan="12">
                                    <form method="get" asp-action="ViewBook" asp-controller="Book" id="searchForm" class="d-flex justify-content-end">
                                        <input type="text" name="searchQuery" id="searchBox" class="form-control me-1" placeholder="Search..." value="@ViewBag.SearchQuery" style="width:20%;">
                                       <button type="submit" class="btn " style="border-radius:60%;background-color:lightpink;opacity:0.7"><i class="bi bi-search text-black"></i></button>
                                    </form>
                                </td>
                           </tr>
                        <tr>
                            <th scope="col">Picture</th>

                            <th scope="col">
                                <a asp-action="ViewBook"  asp-route-sortBy="Name" asp-route-isAscending="@(ViewBag.SortBy == "Name" ? !ViewBag.IsAscending : true)" style="display: flex; align-items: center;text-decoration:none;color:black">
                                    Name
                                    @if (ViewBag.SortBy == "Name")
                                    {
                                        <i class="bi @(ViewBag.IsAscending ? "bi-arrow-up" : "bi-arrow-down")" style="margin-left: 5px;"></i>
                                    }
                                </a>
                            </th>
                            
                            <th scope="col">Description</th>

                            <th scope="col">
                                    <a asp-action="ViewBook"  asp-route-sortBy="Author" asp-route-isAscending="@(ViewBag.SortBy == "Author" ? !ViewBag.IsAscending : true)" style="display: flex; align-items: center;text-decoration:none;color:black">
                                    Author
                                    @if (ViewBag.SortBy == "Author")
                                    {
                                        <i class="bi @(ViewBag.IsAscending ? "bi-arrow-up" : "bi-arrow-down")" style="margin-left: 5px;"></i>
                                    }
                                </a>
                            </th>

                            <th scope="col">Date</th>

                            <th scope="col">Book</th>

                            <th scope="col">Code</th>

                            <th scope="col">
                                    <a asp-action="ViewBook"  asp-route-sortBy="Price" asp-route-isAscending="@(ViewBag.SortBy == "Price" ? !ViewBag.IsAscending : true)" style="display: flex; align-items: center;text-decoration:none;color:black">
                                    Price
                                    @if (ViewBag.SortBy == "Price")
                                    {
                                        <i class="bi @(ViewBag.IsAscending ? "bi-arrow-up" : "bi-arrow-down")" style="margin-left: 5px;"></i>
                                    }
                                </a>
                            </th>

                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                            <th scope="col">To Reserve</th>
                        </tr>


                </thead>
                <tbody>
                    @foreach (var item in Model.Books)
                            {
                                <tr>

                                <td>
                                    <a href="@Url.Content(item.ProfileImage == null ? "~/image/book.jpeg" : "~/image/" + item.ProfileImage)" target="_blank">
                                        <img src="@Url.Content(item.ProfileImage == null ? "~/image/book.jpeg" : "~/image/" + item.ProfileImage)"
                                             width="50" height="50" />
                                    </a>
                                </td>
                                <td>@item.Name</td>
                                    <td>@item.Description</td>
                                    <td>@item.Author</td>
                                    <td>@item.BookCreationDate</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.PdfFileName))
                                    {
                                            <a href="@Url.Content("~/Files/" + item.PdfFileName)" style="color:darkblue;text-decoration:none;" target="_blank">View Book</a>
                                    }
                                    else
                                    {
                                        <span>No Book</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.QRCode))
                                    {
                                        <img src="data:image/png;base64,@item.QRCode" alt="QR Code" width="50" height="50" />
                                    }
                                    
                                </td>
                                    <td>$@item.Price</td>
                                    <td>@item.Status</td>

                                    <td>

                                        <div class="d-inline-flex">

                                            <button type="button" class="btn text-light" style="background-color:darkblue" data-bs-toggle="modal"
                                                data-bs-target="#exampleModal-@item.Id"
                                                onclick="setUserId(@item.Id)">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                            <div class="modal fade" id="exampleModal-@item.Id" data-bs-keyboard="false"
                                                 tabindex="-1" aria-labelledby="exampleModalLabel-@item.Id" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5" id="exampleModalLabel-@item.Id">Update User</h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body text-black">
                                                        <form method="post" asp-action="Update" asp-controller="Book" class="needs-validation" novalidate enctype="multipart/form-data">
                                                                <div class="bg-light rounded h-100 p-4">
                                                           
                                                                    <div class="form-floating mb-3">
                                                                        <input type="text" class="form-control" name="Name" id="floatingInput"
                                                                               placeholder="Name" value="@Model.Book?.Name" />
                                                                        <label for="floatingInput">Name</label>
                                                                    </div>
                                                                    <input type="hidden" name="Id" value="@item.Id" />

                                                                    <div class="form-floating mb-3">
                                                                        <input type="text" class="form-control" name="Description" id="floatingDescription"
                                                                               placeholder="Description" value="@Model.Book?.Description" />
                                                                        <label for="floatingDescription">Description</label>
                                                                    </div>

                                                                    <div class="form-floating mb-3">
                                                                        <input type="text" class="form-control" name="Author" id="floatingAuthor"
                                                                               placeholder="Author" value="@Model.Book?.Author" />
                                                                        <label for="floatingAuthor">Book Author</label>
                                                                    </div>

                                                                    <div class="form-floating mb-3">
                                                                        <input type="date" class="form-control" name="BookCreationDate" id="floatingDate"
                                                                               placeholder="Date" value="@(Model?.Book.BookCreationDate)" />
                                                                        <label for="floatingDate">Book Creation Date</label>
                                                                    </div>
                                                                <div class="form-floating mb-3">
                                                                    <input type="number" class="form-control" name="Price" id="floatingDate"
                                                                           placeholder="Price" value="@(Model?.Book.Price)" />
                                                                    <label for="floatingDate">Price</label>
                                                                </div>
                                                                <div class="form-floating mb-4">
                                                                        <input type="file" class="form-control" name="profileImage" accept="image/*" id="profileImage-@item.Id" placeholder="Image">
                                                                    <label for="profileImage">Book Image</label>
                                                                    <img id="profileImagePreview-@item.Id"
                                                                         src="@(item.ProfileImage != null ? Url.Content("~/Image/" + @item.ProfileImage) : "~/Image/book.jpeg")"
                                                                         alt="Book Image"
                                                                         style="width: 100px; height: 100px; @((item.ProfileImage != null) ? "" : "display: none;")" />

                                                                </div>


                                                                <div class="form-floating mb-4">
                                                                        <input type="file" class="form-control" name="PdfFile" accept="application/pdf" id="pdfFile-@item.Id" placeholder="PDF File">
                                                                    <label for="pdfFile">Book PDF</label>
                                                                    @if (!string.IsNullOrEmpty(item.PdfFileName))
                                                                    {
                                                                        <a href="@Url.Content("~/Files/" + item.PdfFileName)" target="_blank" class="text-black">View PDF</a>
                                                                    }
                                                                </div>
                                                                    <div class="form-floating mb-4">
                                                                        <button id="updateQRButton" type="button" class="btn btn-success d-flex justify-content-center">Update QR</button>

                                                                        @if (ViewBag.QrCodeImage != null)
                                                                        {
                                                                            <div class="mt-4">
                                                                                <img src="data:image/png;base64,@ViewBag.QrCodeImage" alt="QR Code" />
                                                                            </div>
                                                                        }
                                                                        <div id="qrCodeContainer"></div>
                                                                    </div>

                                                                    <button type="submit" class="btn btn-primary d-flex justify-content-center">Submit</button>
                                                                </div>
                                                            </form>

                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>


                                            <button type="button" class="btn text-light btn-danger"  data-bs-toggle="modal" data-bs-target="#deleteModal-@item.Id">
                                                <i class="bi bi-trash"></i>
                                            </button>

                                
                                            <div class="modal fade" id="deleteModal-@item.Id" tabindex="-1" aria-labelledby="deleteModalLabel-@item.Id" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5" id="deleteModalLabel-@item.Id">Confirm Delete</h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to delete the user <strong>@item.Name </strong>?
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                            <form asp-action="Del" asp-controller="Book" method="post">
                                                                <input type="hidden" name="Id" value="@item.Id" />
                                                                <button type="submit" class="btn btn-primary">Yes, Delete</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn text-light " style="background-color:darkblue" id="loadUsers-@item.Id" data-bs-toggle="modal" data-bs-target="#reserveModal-@item.Id">
                                            Reserved
                                        </button>

                                        <div class="modal fade" id="reserveModal-@item.Id" tabindex="-1" aria-labelledby="reserveModalLabel-@item.Id" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="reserveModalLabel-@item.Id">Reserve a Book</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div>
                                                            <label for="userSelect-@item.Id">Select User</label>
                                                            <form method="post" asp-action="ReserveBook" asp-controller="Book">
                                                           
                                                            <select id="userSelect-@item.Id" class="form-control">
                                                           
                                                          
                                                                <option value="">Loading...</option>
                                                            </select>
                                                            </form>

                                                        </div>
                                                        <div id="userList-@item.Id" class="mt-4"></div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="button" class="btn btn-primary"  id="confirmReserve-@item.Id">Reserve</button>
                                                   
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                </tbody>
            </table>
          </div>

                <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                    Showing @ViewBag.Books.Count of @ViewBag.TotalCount books
                </span>
                <ul class="pagination mb-0">
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("ViewBook", new { page = i, pageSize = ViewBag.PageSize, searchQuery = ViewBag.SearchQuery })">@i</a>
                        </li>
                    }
                </ul>



            </div>
        
   
        </div>
    </div>
</div>
<script src="https://cdn.mobiscroll.com/5.10.0/js/mobiscroll.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#multiple-select').mobiscroll().select({
            inputElement: document.getElementById('my-input'),
            touchUi: false
        });
    });

   

</script>

    <script>
        document.getElementById('searchBox').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                document.getElementById('searchForm').submit(); // Submit the form on Enter key press
            }
        });

        document.querySelector('button[type="submit"]').addEventListener('click', function () {
            document.getElementById('searchForm').submit(); // Submit the form on button click
        });
    </script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#updateQRButton").click(function () {
                const name = $("#floatingInput").val();

                    alert("Please enter a name before generating a QR code.");
                if (!name) {
                    return;
                }

                $.ajax({
                    url: '/Book/Generate', // Submit to the same Generate action
                    type: 'POST',
                    data: { Name: name }, // Send form data (no JSON serialization needed)
                    success: function (response) {
                        // Handle the QR code image display
                        const qrCodeImageBase64 = response.qrCodeImage;
                        const imgElement = `<img src="data:image/png;base64,${qrCodeImageBase64}" alt="QR Code" class="mt-3" />`;
                        $("#qrCodeContainer").html(imgElement); // Display the QR code below the button
                    },
                    error: function (xhr, status, error) {
                        alert("An error occurred while generating the QR code: " + xhr.responseText);
                    }
                });
            });
        });
    </script>

